<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">

    <title>Twit Service</title>
</head>

<body>
    <div class="container">
        <div class="row">
            <p></p>
        </div>
        <div class="row">
            <div class="card" style="width: 35rem;">
                <div class="card-body">
                    <h5 class="card-title">User profile</h5>
                    <div class="card-text">
                        <div class="input-group input-group-sm mb-3">
                            <span class="input-group-text" id="inputGroup-sizing-sm">LINE ID</span>
                            <input id="userId" class="form-control" type="text" value="" readonly>
                        </div>
                        <div class="input-group input-group-sm mb-3">
                            <span class="input-group-text" id="inputGroup-sizing-sm">Name</span>
                            <input id="userName" class="form-control" type="text" value="" readonly>
                        </div>
                        <div class="input-group input-group-sm mb-3">
                            <span class="input-group-text" id="inputGroup-sizing-sm">User ID</span>
                            <input id="registeredUserId" class="form-control" type="text" value="" readonly>
                        </div>
                        <div class="input-group input-group-sm mb-3">
                            <span class="input-group-text" id="inputGroup-sizing-sm">Wallet Address</span>
                            <input id="registeredWalletAddress" class="form-control" type="text" value="" readonly>
                            <a href="#" class="text-decoration-none" id="walletExplorer" style="margin-left: 0.3em;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z">
                                    </path>
                                    <path fill-rule="evenodd"
                                        d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z">
                                    </path>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <p></p>
        </div>

        <div class="row">
            <div class="card" style="width: 35rem;">
                <div class="card-body">
                    <h5 class="card-title">User register</h5>
                    <div class="input-group input-group-sm mb-3">
                        <span class="input-group-text" id="inputGroup-sizing-sm">Wallet Address</span>
                        <input id="walletAddress" class="form-control" type="text" name="walletAddress"
                            title="wallet address" value="tlink1kq38rvduzxv3u9kyfcca9pme6cpexq4qhea8xv">
                    </div>
                    <button type="button" class="btn btn-primary" id="registerWallet"
                        onclick="registerWalletAddress()">Register</button>
                </div>
            </div>
        </div>

        <div class="row">
            <p></p>
        </div>

        <div class="row">
            <div class="card" style="width: 35rem;">
                <div class="card-body">
                    <h5 class="card-title">Create Twit</h5>
                    <div class="input-group input-group-sm mb-3">
                        <span class="input-group-text" id="inputGroup-sizing-sm">Twit Message</span>
                        <input id="twitMessage" class="form-control" type="text" name="twitMessage"
                            title="your twit message" value="">
                    </div>
                    <button type="button" class="btn btn-primary" id="registerTwit" onclick="createTwit()">Twit</button>
                </div>
            </div>
        </div>

        <div class="row">
            <p></p>
        </div>

        <div class="row">
            <div class="card" style="width: 100rem;">
                <h5 class="card-title">My Twits</h5>
                <table id="myTwitListTable" border="1" class="table">
                    <thead>
                        <tr>
                            <td>twit message</td>
                            <td>created at</td>
                            <td>owner-id</td>
                            <td>like</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <p></p>
                <button class="btn btn-primary" id="refreshTwit" onclick="fetchMyTwits()">Refresh</button>
            </div>
        </div>

        <div class="row">
            <p></p>
        </div>

        <div class="row">
            <div class="card" style="width: 100rem;">
                <h5 class="card-title">My Twit NFTs</h5>
                <table id="myTwitsNFTListTable" border="1" class="table">
                    <thead>
                        <tr>
                            <td>token-id</td>
                            <td>txHash</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <p></p>
                <button class="btn btn-primary" id="refreshTwitNft" onclick="fetchMyTwitNFTs()">Refresh</button>
            </div>
        </div>

        <div class="row">
            <p></p>
        </div>

        <div class="row">
            <div class="card" style="width: 100rem;">
                <h5 class="card-title">My Rewards</h5>
                <table id="myRewardListTable" border="1" class="table">
                    <thead>
                        <tr>
                            <td>user-id</td>
                            <td>twit-id</td>
                            <td>reward-amount</td>
                            <td>txHash</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <p></p>
                <button class="btn btn-primary" id="refreshRewardHistory" onclick="fetchMyRewards()">Refresh</button>
            </div>
        </div>
    </div>

    <template id="myTwitRow">
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td>
                <button>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-star" viewBox="0 0 16 16">
                        <path
                            d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.565.565 0 0 0-.163-.505L1.71 6.745l4.052-.576a.525.525 0 0 0 .393-.288L8 2.223l1.847 3.658a.525.525 0 0 0 .393.288l4.052.575-2.906 2.77a.565.565 0 0 0-.163.506l.694 3.957-3.686-1.894a.503.503 0 0 0-.461 0z" />
                    </svg>
                </button>
            </td>
        </tr>
    </template>

    <template id="myTwitNFTListRow">
        <tr>
            <td></td>
            <td>
                <a href=""></a>
            </td>
        </tr>
    </template>

    <template id="myRewardListRow">
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td><a href=""></a></td>
        </tr>
    </template>
    <script>
        function fetchMyTwits() {
            var registeredUserId = document.getElementById("registeredUserId").value
            console.log("registeredUserId", registeredUserId);
            if (!registeredUserId || registeredUserId.length < 1) {
                return;
            }
            var fetchUrl = `/users/${registeredUserId}/twits`
            fetch(fetchUrl).then(function (response) {
                response.json().then(function (twits) {
                    displayMyTwits(twits);
                });
            });

            setTimeout(fetchMyTwitNFTs(), 3000);
        }

        function fetchMyTwitNFTs() {
            // /users/:userId/twits
            var registeredUserId = document.getElementById("registeredUserId").value
            console.log("registeredUserId", registeredUserId);
            if (!registeredUserId || registeredUserId.length < 1) {
                return;
            }
            var fetchUrl = `/users/${registeredUserId}/twits-nft`

            fetch(fetchUrl).then(function (response) {
                response.json().then(function (twits) {
                    displayMyTwitNFTs(twits);
                });
            });
        }

        function fetchMyRewards() {
            var registeredUserId = document.getElementById("registeredUserId").value
            console.log("registeredUserId", registeredUserId);
            if (!registeredUserId || registeredUserId.length < 1) {
                return;
            }
            var fetchUrl = `/users/${registeredUserId}/rewards-history`

            fetch(fetchUrl).then(function (response) {
                response.json().then(function (rewardHistories) {
                    displayMyRewards(rewardHistories);
                });
            });
        }

        function fetchSession() {
            fetch("/session").then(function (response) {
                response.json().then(function (session) {
                    document.getElementById("userId").value = session["profile"]["userId"];
                    document.getElementById("userName").value = session["profile"]["displayName"];
                    // document.getElementById("profileImage").src = session["profile"]["pictureUrl"];
                    document.getElementById("registeredUserId").value = session["id"];
                    document.getElementById("registeredWalletAddress").value = session["walletAddress"];
                    
                    document.getElementById("walletExplorer").href = `https://explorer.blockchain.line.me/cashew/address/${session["walletAddress"]}`;
                    document.getElementById("walletExplorer").target = "_blank";

                    fetch(`/users/by/line-user-id/${session["profile"]["userId"]}`).then(function (response) {
                        response.json().then(function (user) {
                            document.getElementById("registeredUserId").value = user.id;
                            document.getElementById("registeredWalletAddress").value = user.walletAddress;
                            document.getElementById("walletExplorer").href = `https://explorer.blockchain.line.me/cashew/address/${user.walletAddress}`;
                            document.getElementById("walletExplorer").target = "_blank";
                        });
                    });
                });
            });
        }

        function registerWalletAddress() {
            var userRegistrationData = createUserRegistrationData()
            if (!userRegistrationData.user.walletAddress && userRegistrationData.user.walletAddress.length < 1) {
                alert("Invalid wallet address");
            } else {
                var userData = JSON.stringify(userRegistrationData);

                fetch("/users", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: userData
                }).then(function (response) {
                    response.json().then(function (createdUser) {
                        document.getElementById("registeredUserId").value = createdUser.id;
                        document.getElementById("registeredWalletAddress").value = createdUser.walletAddress;
                        document.getElementById("walletExplorer").href = `https://explorer.blockchain.line.me/cashew/address/${createdUser.walletAddress}`;
                        document.getElementById("walletExplorer").target = "_blank";
                    })
                });
            }
        }

        function createUserRegistrationData() {
            var walletAddress = document.getElementById("walletAddress").value;
            return {
                "user": {
                    "name": document.getElementById("userName").value,
                    "walletAddress": walletAddress,
                    "lineUserId": document.getElementById("userId").value
                }
            }
        }

        function displayMyTwits(twits) {
            var tbody = document.querySelector("table#myTwitListTable tbody");
            tbody.innerHTML = "";
            var rowTemplate = document.getElementById("myTwitRow");

            [...twits].forEach(function (twit) {
                var clone = document.importNode(rowTemplate.content, true);
                td = clone.querySelectorAll("td");
                td[0].textContent = twit.message;
                td[1].textContent = twit.createdAt;
                td[2].textContent = twit.owner;

                var likeButton = td[3].querySelector("button");
                likeButton.className = "btn btn-sm btn-success";
                likeButton.setAttribute("onclick", `likeTwit('${twit.owner}', '${twit.id}')`)

                tbody.appendChild(clone);

            })
        }

        //
        function displayMyTwitNFTs(twitNFTs) {
            var tbody = document.querySelector("table#myTwitsNFTListTable tbody");
            tbody.innerHTML = "";
            var rowTemplate = document.getElementById("myTwitNFTListRow");

            [...twitNFTs].forEach(function (twitNFT) {
                var clone = document.importNode(rowTemplate.content, true);
                td = clone.querySelectorAll("td");
                td[0].textContent = twitNFT.tokenId;
                var txHashLink = td[1].querySelector("a");
                txHashLink.textContent = twitNFT.txHash;
                txHashLink.href = `https://explorer.blockchain.line.me/cashew/transaction/${twitNFT.txHash}`;
                tbody.appendChild(clone);
            })
        }

        function displayMyRewards(rewardsHistories) {
            if (!rewardsHistories || rewardsHistories.length < 1) {
                return;
            }
            var tbody = document.querySelector("table#myRewardListTable tbody");
            tbody.innerHTML = "";
            var rowTemplate = document.getElementById("myRewardListRow");

            [...rewardsHistories].forEach(function (rewardHistory) {
                var clone = document.importNode(rowTemplate.content, true);
                td = clone.querySelectorAll("td");
                td[0].textContent = rewardHistory.userId;
                td[1].textContent = rewardHistory.twitId;
                td[2].textContent = rewardHistory.rewardAmount;
                var txHashLink = td[3].querySelector("a");
                txHashLink.textContent = rewardHistory.txHash;
                txHashLink.href = `https://explorer.blockchain.line.me/cashew/transaction/${rewardHistory.txHash}`;
                tbody.appendChild(clone);
            });
        }

        function createTwit() {
            var twitMessage = document.getElementById("twitMessage").value;
            if (!twitMessage || twitMessage.length < 1) {
                return;
            }
            var systemUserId = document.getElementById("registeredUserId").value;
            if (!systemUserId || systemUserId.length < 1) {
                return;
            }
            var requestUrl = `/users/${systemUserId}/twits`
            var twitData = {
                "message": twitMessage
            };
            fetch(requestUrl, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(twitData)
            }).then(function (response) {
                fetchMyTwits();
            });
        }

        function likeTwit(ownerId, twitId) {
            //
            console.log("like twit", ownerId, twitId);

            var systemUserId = document.getElementById("registeredUserId").value;
            if (!ownerId || ownerId.length < 1) {
                return;
            }
            if (!twitId || twitId.length < 1) {
                return;
            }
            var requestUrl = `/users/${ownerId}/twits/${twitId}/likes`
            fetch(requestUrl, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(function (response) {
                setTimeout(fetchMyRewards(), 3000);
            });
        }

        fetchSession();

    </script>
</body>


</html>